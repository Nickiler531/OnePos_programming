<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>OnePos: NVM driver flash handling</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">OnePos
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#typedef-members">Typedefs</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">NVM driver flash handling</div>  </div>
<div class="ingroups"><a class="el" href="group__nvm__group.html">NVM service</a></div></div><!--header-->
<div class="contents">

<p>Functions for handling internal flash memory.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:ga1ff021ee17a7d4814fe900414e870c4f"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__nvm__flash__group.html#ga1ff021ee17a7d4814fe900414e870c4f">IAR_FLASH_PTR</a>&#160;&#160;&#160;__flash</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2><a name="typedef-members"></a>
Typedefs</h2></td></tr>
<tr class="memitem:ga95a069fc064dc9cd089b7d9047b909b0"><td class="memItemLeft" align="right" valign="top">typedef uint16_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__nvm__flash__group.html#ga95a069fc064dc9cd089b7d9047b909b0">flash_addr_t</a></td></tr>
<tr class="memdesc:ga95a069fc064dc9cd089b7d9047b909b0"><td class="mdescLeft">&#160;</td><td class="mdescRight">Size of a flash page in bytes.  <a href="#ga95a069fc064dc9cd089b7d9047b909b0"></a><br/></td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ga335244745ba451fade7e5a0215aaef4f"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__nvm__flash__group.html#ga335244745ba451fade7e5a0215aaef4f">nvm_issue_flash_range_crc</a> (<a class="el" href="group__nvm__flash__group.html#ga95a069fc064dc9cd089b7d9047b909b0">flash_addr_t</a> start_addr, <a class="el" href="group__nvm__flash__group.html#ga95a069fc064dc9cd089b7d9047b909b0">flash_addr_t</a> end_addr)</td></tr>
<tr class="memdesc:ga335244745ba451fade7e5a0215aaef4f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Issue flash range CRC command.  <a href="#ga335244745ba451fade7e5a0215aaef4f"></a><br/></td></tr>
<tr class="memitem:gae5fd84639f16bdf897cf3ed4e634634f"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__nvm__flash__group.html#gae5fd84639f16bdf897cf3ed4e634634f">nvm_flash_read_buffer</a> (<a class="el" href="group__nvm__flash__group.html#ga95a069fc064dc9cd089b7d9047b909b0">flash_addr_t</a> address, void *buf, uint16_t len)</td></tr>
<tr class="memdesc:gae5fd84639f16bdf897cf3ed4e634634f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Read buffer within the application section.  <a href="#gae5fd84639f16bdf897cf3ed4e634634f"></a><br/></td></tr>
<tr class="memitem:gaf16cad66506bd55382a66c83e0aa0c23"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__nvm__flash__group.html#gaf16cad66506bd55382a66c83e0aa0c23">nvm_user_sig_read_buffer</a> (<a class="el" href="group__nvm__flash__group.html#ga95a069fc064dc9cd089b7d9047b909b0">flash_addr_t</a> address, void *buf, uint16_t len)</td></tr>
<tr class="memdesc:gaf16cad66506bd55382a66c83e0aa0c23"><td class="mdescLeft">&#160;</td><td class="mdescRight">Read buffer within the user section.  <a href="#gaf16cad66506bd55382a66c83e0aa0c23"></a><br/></td></tr>
<tr class="memitem:ga5a18a268987412df30e291fa4e43e37f"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__nvm__flash__group.html#ga5a18a268987412df30e291fa4e43e37f">nvm_user_sig_write_buffer</a> (<a class="el" href="group__nvm__flash__group.html#ga95a069fc064dc9cd089b7d9047b909b0">flash_addr_t</a> address, const void *buf, uint16_t len, <a class="el" href="group__group__xmega__utils.html#ga97a80ca1602ebf2303258971a2c938e2">bool</a> b_blank_check)</td></tr>
<tr class="memdesc:ga5a18a268987412df30e291fa4e43e37f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Write specific parts of user flash section.  <a href="#ga5a18a268987412df30e291fa4e43e37f"></a><br/></td></tr>
<tr class="memitem:ga05906a0e64d2527fe92511c364548ebc"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__nvm__flash__group.html#ga05906a0e64d2527fe92511c364548ebc">nvm_flash_erase_and_write_buffer</a> (<a class="el" href="group__nvm__flash__group.html#ga95a069fc064dc9cd089b7d9047b909b0">flash_addr_t</a> address, const void *buf, uint16_t len, <a class="el" href="group__group__xmega__utils.html#ga97a80ca1602ebf2303258971a2c938e2">bool</a> b_blank_check)</td></tr>
<tr class="memdesc:ga05906a0e64d2527fe92511c364548ebc"><td class="mdescLeft">&#160;</td><td class="mdescRight">Erase and write specific parts of application flash section.  <a href="#ga05906a0e64d2527fe92511c364548ebc"></a><br/></td></tr>
<tr class="memitem:ga56f341c1aef558bd9b6504f5a6a95ef2"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__nvm__flash__group.html#ga56f341c1aef558bd9b6504f5a6a95ef2">nvm_flash_load_word_to_buffer</a> (uint32_t word_addr, uint16_t data)</td></tr>
<tr class="memdesc:ga56f341c1aef558bd9b6504f5a6a95ef2"><td class="mdescLeft">&#160;</td><td class="mdescRight">Load word into flash page buffer.  <a href="#ga56f341c1aef558bd9b6504f5a6a95ef2"></a><br/></td></tr>
</table>
<hr/><a name="details" id="details"></a><h2>Detailed Description</h2>
<p>Functions for handling internal flash memory. </p>
<p>The internal flash memory on the XMEGA devices consists of the application section, the application table section and the bootloader section. All these sections can store program code for the MCU, but if there is available space, they can be used for storing other persistent data.</p>
<p>Writing the flash memory can only be done one page at a time. It consists of loading the data to the internal page buffer and then running one of the write commands. If the page has not been erased before writing, the data will not be written correctly.</p>
<p>In order to be able to write to flash memory the programming commands need to be run from the boot section.</p>
<ul>
<li>When using IAR this is handled automatically by the linker script.</li>
<li>When using GCC this needs to be specified manually in the make files. For example the ATxmega128A1 has the boot section at the word address 0x10000 the corresponding byte address of 0x20000 needs to be added to the config.mk makefile: LDFLAGS += -Wl,&ndash;section-start=.BOOT=0x20000 See the device datasheet for the correct address for other devices.</li>
</ul>
<dl class="section note"><dt>Note:</dt><dd>If using GCC and the flash sub-module, remember to configure the boot section in the make file.</dd>
<dd>
The functions in this module are modifying the NVM.CMD register. If the application are using program space access in interrupts (__flash pointers in IAR EW or pgm_read_byte in GCC) interrupts needs to be disabled when running EEPROM access functions. If not the program space reads will be corrupted. </dd></dl>
<hr/><h2>Macro Definition Documentation</h2>
<a class="anchor" id="ga1ff021ee17a7d4814fe900414e870c4f"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define IAR_FLASH_PTR&#160;&#160;&#160;__flash</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Flash pointer type to use for accessing flash memory with IAR </p>

</div>
</div>
<hr/><h2>Typedef Documentation</h2>
<a class="anchor" id="ga95a069fc064dc9cd089b7d9047b909b0"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef uint16_t <a class="el" href="group__nvm__flash__group.html#ga95a069fc064dc9cd089b7d9047b909b0">flash_addr_t</a></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Size of a flash page in bytes. </p>
<p>The page size in bytes taken from the toolchain header files.</p>
<dl class="section note"><dt>Note:</dt><dd>Page size is currently missing from the IAR header files, so it needs to be defined in the driver until it is fixed. Data type for holding flash memory addresses. </dd></dl>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="ga05906a0e64d2527fe92511c364548ebc"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void nvm_flash_erase_and_write_buffer </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="group__nvm__flash__group.html#ga95a069fc064dc9cd089b7d9047b909b0">flash_addr_t</a>&#160;</td>
          <td class="paramname"><em>address</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const void *&#160;</td>
          <td class="paramname"><em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint16_t&#160;</td>
          <td class="paramname"><em>len</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="group__group__xmega__utils.html#ga97a80ca1602ebf2303258971a2c938e2">bool</a>&#160;</td>
          <td class="paramname"><em>b_blank_check</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Erase and write specific parts of application flash section. </p>
<dl class="params"><dt>Parameters:</dt><dd>
  <table class="params">
    <tr><td class="paramname">address</td><td>the address to where to write </td></tr>
    <tr><td class="paramname">buf</td><td>pointer to the data </td></tr>
    <tr><td class="paramname">len</td><td>the number of bytes to write </td></tr>
    <tr><td class="paramname">b_blank_check</td><td>if True then the page flash is checked before write to run or not the erase page command.</td></tr>
  </table>
  </dd>
</dl>
<p>Set b_blank_check to false if all application flash is erased before. </p>

</div>
</div>
<a class="anchor" id="ga56f341c1aef558bd9b6504f5a6a95ef2"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void nvm_flash_load_word_to_buffer </td>
          <td>(</td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>word_addr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint16_t&#160;</td>
          <td class="paramname"><em>data</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Load word into flash page buffer. </p>
<p>Clear the NVM controller page buffer for flash. This needs to be called before using <a class="el" href="group__nvm__flash__group.html#ga56f341c1aef558bd9b6504f5a6a95ef2">nvm_flash_load_word_to_buffer</a> if it has not already been cleared.</p>
<dl class="params"><dt>Parameters:</dt><dd>
  <table class="params">
    <tr><td class="paramname">word_addr</td><td>Address to store data. The upper bits beyond the page size is ignored. FLASH_PAGE_SIZE </td></tr>
    <tr><td class="paramname">data</td><td>Data word to load into the page buffer </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a class="anchor" id="gae5fd84639f16bdf897cf3ed4e634634f"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void nvm_flash_read_buffer </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="group__nvm__flash__group.html#ga95a069fc064dc9cd089b7d9047b909b0">flash_addr_t</a>&#160;</td>
          <td class="paramname"><em>address</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint16_t&#160;</td>
          <td class="paramname"><em>len</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Read buffer within the application section. </p>
<dl class="params"><dt>Parameters:</dt><dd>
  <table class="params">
    <tr><td class="paramname">address</td><td>the address to where to read </td></tr>
    <tr><td class="paramname">buf</td><td>pointer to the data </td></tr>
    <tr><td class="paramname">len</td><td>the number of bytes to read </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a class="anchor" id="ga335244745ba451fade7e5a0215aaef4f"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void nvm_issue_flash_range_crc </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="group__nvm__flash__group.html#ga95a069fc064dc9cd089b7d9047b909b0">flash_addr_t</a>&#160;</td>
          <td class="paramname"><em>start_addr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="group__nvm__flash__group.html#ga95a069fc064dc9cd089b7d9047b909b0">flash_addr_t</a>&#160;</td>
          <td class="paramname"><em>end_addr</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Issue flash range CRC command. </p>
<p>This function sets the FLASH range CRC command in the NVM.CMD register. It then loads the start and end byte address of the part of FLASH to generate a CRC-32 for into the ADDR and DATA registers and finally performs the execute command.</p>
<dl class="section note"><dt>Note:</dt><dd>Should only be called from the CRC module. The function saves and restores the NVM.CMD register, but if this function is called from an interrupt, interrupts must be disabled before this function is called.</dd></dl>
<dl class="params"><dt>Parameters:</dt><dd>
  <table class="params">
    <tr><td class="paramname">start_addr</td><td>end byte address </td></tr>
    <tr><td class="paramname">end_addr</td><td>start byte address </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a class="anchor" id="gaf16cad66506bd55382a66c83e0aa0c23"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void nvm_user_sig_read_buffer </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="group__nvm__flash__group.html#ga95a069fc064dc9cd089b7d9047b909b0">flash_addr_t</a>&#160;</td>
          <td class="paramname"><em>address</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint16_t&#160;</td>
          <td class="paramname"><em>len</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Read buffer within the user section. </p>
<dl class="params"><dt>Parameters:</dt><dd>
  <table class="params">
    <tr><td class="paramname">address</td><td>the address to where to read </td></tr>
    <tr><td class="paramname">buf</td><td>pointer to the data </td></tr>
    <tr><td class="paramname">len</td><td>the number of bytes to read </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a class="anchor" id="ga5a18a268987412df30e291fa4e43e37f"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void nvm_user_sig_write_buffer </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="group__nvm__flash__group.html#ga95a069fc064dc9cd089b7d9047b909b0">flash_addr_t</a>&#160;</td>
          <td class="paramname"><em>address</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const void *&#160;</td>
          <td class="paramname"><em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint16_t&#160;</td>
          <td class="paramname"><em>len</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="group__group__xmega__utils.html#ga97a80ca1602ebf2303258971a2c938e2">bool</a>&#160;</td>
          <td class="paramname"><em>b_blank_check</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Write specific parts of user flash section. </p>
<dl class="params"><dt>Parameters:</dt><dd>
  <table class="params">
    <tr><td class="paramname">address</td><td>the address to where to write </td></tr>
    <tr><td class="paramname">buf</td><td>pointer to the data </td></tr>
    <tr><td class="paramname">len</td><td>the number of bytes to write </td></tr>
    <tr><td class="paramname">b_blank_check</td><td>if True then the page flash is checked before write to run or not the erase page command.</td></tr>
  </table>
  </dd>
</dl>
<p>Set b_blank_check to false if all application flash is erased before. </p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Oct 10 2017 23:17:49 for OnePos by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.1.1
</small></address>
</body>
</html>
