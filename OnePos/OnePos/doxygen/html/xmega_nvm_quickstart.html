<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>OnePos: Quick Start Guide for the XMEGA NVM Driver</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">OnePos
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Quick Start Guide for the XMEGA NVM Driver </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This is the quick start guide for the <a class="el" href="group__nvm__group.html">NVM Driver</a>, with step-by-step instructions on how to configure and use the driver for specific use cases.</p>
<p>The section described below can be compiled into e.g. the main application loop or any other function that will need to interface non-volatile memory.</p>
<h1><a class="anchor" id="xmega_nvm_quickstart_basic"></a>
Basic usage of the NVM driver</h1>
<p>This section will present three use cases of the NVM driver. The first will write a page to EEPROM and verify that it has been written, the second will access the BOD-level fuse to verify that the level is correctly set, and the third will read a chunk from the user signature row.</p>
<h1><a class="anchor" id="xmega_nvm_quickstart_eeprom_case"></a>
Use case 1: EEPROM</h1>
<p>The NVM driver has functions for interfacing many types of non-volatile memory, including flash, EEPROM, fuses and lock bits. The example code below will write a page to the internal EEPROM, and read it back to verify, using memory mapped I/O.</p>
<h1><a class="anchor" id="xmega_nvm_quickstart_eeprom_case_setup_steps"></a>
Setup steps</h1>
<p>There are no setup steps required for this use case.</p>
<h2><a class="anchor" id="nvm_quickstart_eeprom_case_example_code"></a>
Example code</h2>
<div class="fragment"><div class="line"><span class="preprocessor">         #define EXAMPLE_PAGE 2</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">         #define EXAMPLE_ADDR EXAMPLE_PAGE * EEPROM_PAGE_SIZE</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">         uint8_t write_page[EEPROM_PAGE_SIZE];</div>
<div class="line">         uint8_t read_page[EEPROM_PAGE_SIZE];</div>
<div class="line"></div>
<div class="line">         fill_page_with_known_data(write_page);</div>
<div class="line">         fill_page_with_zeroes(read_page);</div>
<div class="line"></div>
<div class="line">         <a class="code" href="group__nvm__eeprom__group.html#ga02f10adbf959b8525bbaf777ad6e43b6" title="Load entire page into temporary EEPROM page buffer.">nvm_eeprom_load_page_to_buffer</a>(write_page);</div>
<div class="line">         <a class="code" href="group__nvm__eeprom__group.html#ga6f939f98287b320d39418ed72ba8cfe1" title="Erase and write bytes from page buffer into EEPROM.">nvm_eeprom_atomic_write_page</a>(EXAMPLE_PAGE);</div>
<div class="line"></div>
<div class="line">         <a class="code" href="group__nvm__eeprom__group.html#ga723a1c1ef60ffb4d220f28c99e6c3014" title="Read buffer within the eeprom.">nvm_eeprom_read_buffer</a>(EXAMPLE_ADDR,</div>
<div class="line">                 read_page, EEPROM_PAGE_SIZE);</div>
<div class="line"></div>
<div class="line">         check_if_pages_are_equal(write_page, read_page);</div>
</div><!-- fragment --><h2><a class="anchor" id="nvm_quickstart_eeprom_case_workflow"></a>
Workflow</h2>
<ol type="1">
<li>We define where we would like to store our data, and we arbitrarily choose page 2 of EEPROM:<ul>
<li><div class="fragment"><div class="line"><span class="preprocessor">        #define EXAMPLE_PAGE 2</span></div>
<div class="line"><span class="preprocessor">        #define EXAMPLE_ADDR EXAMPLE_PAGE * EEPROM_PAGE_SIZE</span></div>
</div><!-- fragment --></li>
</ul>
</li>
<li>Define two tables, one which contains the data which we will write, and one which we will read the data into:<ul>
<li><div class="fragment"><div class="line">        uint8_t write_page[EEPROM_PAGE_SIZE];</div>
<div class="line">        uint8_t read_page[EEPROM_PAGE_SIZE];</div>
</div><!-- fragment --></li>
</ul>
</li>
<li>Fill the tables with our data, and zero out the read table:<ul>
<li><div class="fragment"><div class="line">        fill_page_with_known_data(write_page);</div>
<div class="line">        fill_page_with_zeroes(read_page);</div>
</div><!-- fragment --></li>
<li><dl class="section note"><dt>Note:</dt><dd>These functions are undeclared, you should replace them with your own appropriate functions.</dd></dl>
</li>
</ul>
</li>
<li>We load our page into a temporary EEPROM page buffer:<ul>
<li><div class="fragment"><div class="line">        <a class="code" href="group__nvm__eeprom__group.html#ga02f10adbf959b8525bbaf777ad6e43b6" title="Load entire page into temporary EEPROM page buffer.">nvm_eeprom_load_page_to_buffer</a>(write_page);</div>
</div><!-- fragment --></li>
<li><dl class="section attention"><dt>Attention:</dt><dd>The function used above will not work if memory mapping is enabled.</dd></dl>
</li>
</ul>
</li>
<li>Do an atomic write of the page from buffer into the specified page:<ul>
<li><div class="fragment"><div class="line">        <a class="code" href="group__nvm__eeprom__group.html#ga6f939f98287b320d39418ed72ba8cfe1" title="Erase and write bytes from page buffer into EEPROM.">nvm_eeprom_atomic_write_page</a>(EXAMPLE_PAGE);</div>
</div><!-- fragment --></li>
<li><dl class="section note"><dt>Note:</dt><dd>The function <a class="el" href="group__nvm__eeprom__group.html#ga6f939f98287b320d39418ed72ba8cfe1">nvm_eeprom_atomic_write_page()</a> erases the page before writing the new one. For non-atomic (split) writing without deleting, see <a class="el" href="group__nvm__eeprom__group.html#gae8b5ca90e2d370109bed6e6adc8d9307">nvm_eeprom_split_write_page()</a></dd></dl>
</li>
</ul>
</li>
<li>Read the page back into our read_page[] table:<ul>
<li><div class="fragment"><div class="line">        <a class="code" href="group__nvm__eeprom__group.html#ga723a1c1ef60ffb4d220f28c99e6c3014" title="Read buffer within the eeprom.">nvm_eeprom_read_buffer</a>(EXAMPLE_ADDR,</div>
<div class="line">                read_page, EEPROM_PAGE_SIZE);</div>
</div><!-- fragment --></li>
</ul>
</li>
<li>Verify that the page is equal to the one that was written earlier:<ul>
<li><div class="fragment"><div class="line">        check_if_pages_are_equal(write_page, read_page);</div>
</div><!-- fragment --></li>
<li><dl class="section note"><dt>Note:</dt><dd>This function is not declared, you should replace it with your own appropriate function.</dd></dl>
</li>
</ul>
</li>
</ol>
<h1><a class="anchor" id="xmega_nvm_quickstart_fuse_case"></a>
Use case 2: Fuses</h1>
<p>The NVM driver has functions for reading fuses. See <a class="el" href="group__nvm__fuse__lock__group.html">NVM driver fuse and lock bits handling</a>.</p>
<p>We would like to check whether the Brown-out Detection level is set to 2.1V. This is set by programming the fuses when the chip is connected to a suitable programmer. The fuse is a part of FUSEBYTE5. If the BODLVL is correct, we turn on LED0.</p>
<h1><a class="anchor" id="xmega_nvm_quickstart_fuse_case_setup_steps"></a>
Setup steps</h1>
<p>There are no setup steps required for this use case.</p>
<h2><a class="anchor" id="nvm_quickstart_fuse_case_example_code"></a>
Example code</h2>
<div class="fragment"><div class="line">         uint8_t fuse_value;</div>
<div class="line">         fuse_value = <a class="code" href="group__nvm__fuse__lock__group.html#ga7f38ae8b811b4b6c7a209e37cfe1b03d" title="Read a fuse byte.">nvm_fuses_read</a>(FUSEBYTE5);</div>
<div class="line"></div>
<div class="line">         <span class="keywordflow">if</span> ((fuse_value &amp; NVM_FUSES_BODLVL_gm) == BODLVL_2V1_gc) {</div>
<div class="line">             gpio_set_pin_low(LED0_GPIO);</div>
<div class="line">         }</div>
</div><!-- fragment --><h2><a class="anchor" id="nvm_quickstart_fuse_case_workflow"></a>
Workflow</h2>
<ol type="1">
<li>Create a variable to store the fuse contents:<ul>
<li><div class="fragment"><div class="line">        uint8_t fuse_value;</div>
</div><!-- fragment --></li>
</ul>
</li>
<li>The fuse value we are interested in, BODLVL, is stored in FUSEBYTE5. We call the function <a class="el" href="group__nvm__fuse__lock__group.html#ga7f38ae8b811b4b6c7a209e37cfe1b03d">nvm_fuses_read()</a> to read the fuse into our variable:<ul>
<li><div class="fragment"><div class="line">        fuse_value = <a class="code" href="group__nvm__fuse__lock__group.html#ga7f38ae8b811b4b6c7a209e37cfe1b03d" title="Read a fuse byte.">nvm_fuses_read</a>(FUSEBYTE5);</div>
</div><!-- fragment --></li>
</ul>
</li>
<li>This ends the reading portion, but we would like to see whether the BOD-level is correct, and if it is, light up an LED:<ul>
<li><div class="fragment"><div class="line">        <span class="keywordflow">if</span> ((fuse_value &amp; NVM_FUSES_BODLVL_gm) == BODLVL_2V1_gc) {</div>
<div class="line">            gpio_set_pin_low(LED0_GPIO);</div>
<div class="line">        }</div>
</div><!-- fragment --></li>
</ul>
</li>
</ol>
<h1><a class="anchor" id="xmega_nvm_quickstart_signature_case"></a>
Use case 3: Signature row</h1>
<p>The NVM driver has functions for reading the signature row of the device. Here we will simply read 16 bytes from the user signature row, assuming we need what is stored there.</p>
<h1><a class="anchor" id="xmega_nvm_quickstart_signature_row_setup_steps"></a>
Setup steps</h1>
<p>There are no setup steps required for this use case.</p>
<h2><a class="anchor" id="xmega_nvm_quickstart_signature_row_example_code"></a>
Example code</h2>
<div class="fragment"><div class="line"><span class="preprocessor">         #define START_ADDR 0x10</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">         #define DATA_LENGTH 16</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">         uint8_t values[LENGTH];</div>
<div class="line">         uint8_t i;</div>
<div class="line"></div>
<div class="line">         <span class="keywordflow">for</span> (i = 0; i &lt; DATA_LENGTH; i++) {</div>
<div class="line">             values[i] = nvm_read_user_signature_row(START_ADDR + i);</div>
<div class="line">         }</div>
</div><!-- fragment --><h2><a class="anchor" id="nvm_quickstart_signature_case_workflow"></a>
Workflow</h2>
<ol type="1">
<li>Define starting address and length of data segment, and create variables needed to store and process the data:<ul>
<li><div class="fragment"><div class="line"><span class="preprocessor">               #define START_ADDR 0x10</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">               #define DATA_LENGTH 16</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">               uint8_t values[LENGTH];</div>
<div class="line">               uint8_t i;</div>
</div><!-- fragment --></li>
</ul>
</li>
<li>Iterate through the user signature row, and store our desired data:<ul>
<li><div class="fragment"><div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; DATA_LENGTH; i++) {</div>
<div class="line">            values[i] = nvm_read_user_signature_row(START_ADDR + i);</div>
<div class="line">        }</div>
</div><!-- fragment --> </li>
</ul>
</li>
</ol>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Oct 10 2017 23:17:48 for OnePos by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.1.1
</small></address>
</body>
</html>
