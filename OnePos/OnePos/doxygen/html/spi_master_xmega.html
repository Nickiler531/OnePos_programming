<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>OnePos: Quick start guide for SPI master on XMEGA devices</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">OnePos
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="common_spi_master_quickstart.html">Quick Start Guide for the SPI Master Driver</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Quick start guide for SPI master on XMEGA devices </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="spi_master_xmega_basic"></a>
Basic setup for XMEGA devices</h1>
<p>The SPI module will be set up as master:</p>
<ul>
<li>SPI on PORTD</li>
<li>1MHz SPI clock speed</li>
<li>Slave Chip Select connected on PORTD pin 1</li>
<li>SPI mode 0 (data on rising clock edge)</li>
</ul>
<h1><a class="anchor" id="spi_master_xmega_basic_setup"></a>
Workflow</h1>
<h2><a class="anchor" id="spi_master_xmega_basic_setup_code"></a>
Example code</h2>
<p>Add to application C-file (e.g. <a class="el" href="main_8c.html" title="Empty user application template.">main.c</a>): </p>
<div class="fragment"><div class="line">           <span class="keywordtype">void</span> spi_init_pins(<span class="keywordtype">void</span>)</div>
<div class="line">           {</div>
<div class="line">               <a class="code" href="ioport__compat_8h.html#a8da4959022f2cec05f59a9939671ff7e" title="Configure the IO PORT pin function for a set of pins on a port.">ioport_configure_port_pin</a>(&amp;PORTD, PIN1_bm, <a class="code" href="ioport__compat_8h.html#a6fd5b83fc296e4d6d791f8b074731d8e">IOPORT_INIT_HIGH</a> | <a class="code" href="group__ioport__group.html#gga9c267f89800e58bd9dfd74e662a4a4c1a06de24313dad0169f3a366c62a84f4cc">IOPORT_DIR_OUTPUT</a>);</div>
<div class="line"></div>
<div class="line">               <a class="code" href="ioport__compat_8h.html#a8da4959022f2cec05f59a9939671ff7e" title="Configure the IO PORT pin function for a set of pins on a port.">ioport_configure_port_pin</a>(&amp;PORTD, PIN4_bm, <a class="code" href="ioport__compat_8h.html#acbd350ec39fe567a7c0e423b000746fb">IOPORT_PULL_UP</a> | <a class="code" href="group__ioport__group.html#gga9c267f89800e58bd9dfd74e662a4a4c1af854a0dce084e5a8e8744f9a502e7b7b">IOPORT_DIR_INPUT</a>);</div>
<div class="line">               <a class="code" href="ioport__compat_8h.html#a8da4959022f2cec05f59a9939671ff7e" title="Configure the IO PORT pin function for a set of pins on a port.">ioport_configure_port_pin</a>(&amp;PORTD, PIN5_bm, <a class="code" href="ioport__compat_8h.html#a6fd5b83fc296e4d6d791f8b074731d8e">IOPORT_INIT_HIGH</a> | <a class="code" href="group__ioport__group.html#gga9c267f89800e58bd9dfd74e662a4a4c1a06de24313dad0169f3a366c62a84f4cc">IOPORT_DIR_OUTPUT</a>);</div>
<div class="line">               <a class="code" href="ioport__compat_8h.html#a8da4959022f2cec05f59a9939671ff7e" title="Configure the IO PORT pin function for a set of pins on a port.">ioport_configure_port_pin</a>(&amp;PORTD, PIN6_bm, <a class="code" href="group__ioport__group.html#gga9c267f89800e58bd9dfd74e662a4a4c1af854a0dce084e5a8e8744f9a502e7b7b">IOPORT_DIR_INPUT</a>);</div>
<div class="line">               <a class="code" href="ioport__compat_8h.html#a8da4959022f2cec05f59a9939671ff7e" title="Configure the IO PORT pin function for a set of pins on a port.">ioport_configure_port_pin</a>(&amp;PORTD, PIN7_bm, <a class="code" href="ioport__compat_8h.html#a6fd5b83fc296e4d6d791f8b074731d8e">IOPORT_INIT_HIGH</a> | <a class="code" href="group__ioport__group.html#gga9c267f89800e58bd9dfd74e662a4a4c1a06de24313dad0169f3a366c62a84f4cc">IOPORT_DIR_OUTPUT</a>);</div>
<div class="line">           }</div>
<div class="line"></div>
<div class="line">           <span class="keywordtype">void</span> spi_init_module(<span class="keywordtype">void</span>)</div>
<div class="line">           {</div>
<div class="line">              <span class="keyword">struct </span><a class="code" href="structspi__device.html" title="Polled SPI device definition.">spi_device</a> spi_device_conf = {</div>
<div class="line">                  .<a class="code" href="structspi__device.html#a46fd65e51a4d6c4d6056639a4f154186" title="Board specific select id.">id</a> = <a class="code" href="group__ioport__group.html#gabc09edad7c3187dec63ce47e6f1b3c51" title="Create IOPORT pin number.">IOPORT_CREATE_PIN</a>(PORTD, 1)</div>
<div class="line">              };</div>
<div class="line"></div>
<div class="line">              <a class="code" href="group__xmega__spi__master__group.html#ga3238676989038a9dec0ebcd3aa625a42" title="Initializes the SPI in master mode.">spi_master_init</a>(&amp;SPID);</div>
<div class="line">              <a class="code" href="group__xmega__spi__master__group.html#ga81164f6dd2297a64337f3a052171e0f8" title="Setup a SPI device.">spi_master_setup_device</a>(&amp;SPID, &amp;spi_device_conf, <a class="code" href="group__xmega__spi__master__group.html#ga1ec07ad94d5f6276c1c0b41d0550fe52" title="SPI mode 0.">SPI_MODE_0</a>, 1000000, 0);</div>
<div class="line">              <a class="code" href="group__xmega__spi__master__group.html#ga82974e81370360e53b1276113de8a462" title="Enables the SPI.">spi_enable</a>(&amp;SPID);</div>
<div class="line">           }</div>
</div><!-- fragment --><h2><a class="anchor" id="spi_master_xmega_basic_setup"></a>
Workflow</h2>
<ol type="1">
<li>Ensure that <a class="el" href="conf__spi__master_8h.html">conf_spi_master.h</a> is present for the driver.<ul>
<li><dl class="section note"><dt>Note:</dt><dd>This file is only for the driver and should not be included by the user. In this example the file can be left empty.</dd></dl>
</li>
</ul>
</li>
<li>Initialize the pins used by the SPI interface (this initialization is for the ATxmega32A4U device).<ol type="a">
<li>Set the pin used for slave select as output high: <div class="fragment"><div class="line">        <a class="code" href="ioport__compat_8h.html#a8da4959022f2cec05f59a9939671ff7e" title="Configure the IO PORT pin function for a set of pins on a port.">ioport_configure_port_pin</a>(&amp;PORTD, PIN1_bm, <a class="code" href="ioport__compat_8h.html#a6fd5b83fc296e4d6d791f8b074731d8e">IOPORT_INIT_HIGH</a> | <a class="code" href="group__ioport__group.html#gga9c267f89800e58bd9dfd74e662a4a4c1a06de24313dad0169f3a366c62a84f4cc">IOPORT_DIR_OUTPUT</a>);</div>
</div><!-- fragment --></li>
<li>Enable pull-up on own chip select (SS): <div class="fragment"><div class="line">        <a class="code" href="ioport__compat_8h.html#a8da4959022f2cec05f59a9939671ff7e" title="Configure the IO PORT pin function for a set of pins on a port.">ioport_configure_port_pin</a>(&amp;PORTD, PIN4_bm, <a class="code" href="ioport__compat_8h.html#acbd350ec39fe567a7c0e423b000746fb">IOPORT_PULL_UP</a> | <a class="code" href="group__ioport__group.html#gga9c267f89800e58bd9dfd74e662a4a4c1af854a0dce084e5a8e8744f9a502e7b7b">IOPORT_DIR_INPUT</a>);</div>
</div><!-- fragment --> <dl class="section attention"><dt>Attention:</dt><dd>If this pin is pulled low the SPI module will go into slave mode.</dd></dl>
</li>
<li>Set MOSI and SCL as output high, and set MISO as input: <div class="fragment"><div class="line">        <a class="code" href="ioport__compat_8h.html#a8da4959022f2cec05f59a9939671ff7e" title="Configure the IO PORT pin function for a set of pins on a port.">ioport_configure_port_pin</a>(&amp;PORTD, PIN5_bm, <a class="code" href="ioport__compat_8h.html#a6fd5b83fc296e4d6d791f8b074731d8e">IOPORT_INIT_HIGH</a> | <a class="code" href="group__ioport__group.html#gga9c267f89800e58bd9dfd74e662a4a4c1a06de24313dad0169f3a366c62a84f4cc">IOPORT_DIR_OUTPUT</a>);</div>
<div class="line">        <a class="code" href="ioport__compat_8h.html#a8da4959022f2cec05f59a9939671ff7e" title="Configure the IO PORT pin function for a set of pins on a port.">ioport_configure_port_pin</a>(&amp;PORTD, PIN6_bm, <a class="code" href="group__ioport__group.html#gga9c267f89800e58bd9dfd74e662a4a4c1af854a0dce084e5a8e8744f9a502e7b7b">IOPORT_DIR_INPUT</a>);</div>
<div class="line">        <a class="code" href="ioport__compat_8h.html#a8da4959022f2cec05f59a9939671ff7e" title="Configure the IO PORT pin function for a set of pins on a port.">ioport_configure_port_pin</a>(&amp;PORTD, PIN7_bm, <a class="code" href="ioport__compat_8h.html#a6fd5b83fc296e4d6d791f8b074731d8e">IOPORT_INIT_HIGH</a> | <a class="code" href="group__ioport__group.html#gga9c267f89800e58bd9dfd74e662a4a4c1a06de24313dad0169f3a366c62a84f4cc">IOPORT_DIR_OUTPUT</a>);</div>
</div><!-- fragment --></li>
</ol>
</li>
<li>Define the SPI device configuration struct to describe which pin the slave select (slave chip select) is connected to, in this case the slave select pin has been connected to PORTD pin 1 (PD1):<ul>
<li><div class="fragment"><div class="line">        <span class="keyword">struct </span><a class="code" href="structspi__device.html" title="Polled SPI device definition.">spi_device</a> spi_device_conf = {</div>
<div class="line">            .<a class="code" href="structspi__device.html#a46fd65e51a4d6c4d6056639a4f154186" title="Board specific select id.">id</a> = <a class="code" href="group__ioport__group.html#gabc09edad7c3187dec63ce47e6f1b3c51" title="Create IOPORT pin number.">IOPORT_CREATE_PIN</a>(PORTD, 1)</div>
<div class="line">        };</div>
</div><!-- fragment --></li>
</ul>
</li>
<li>Initialize the SPI module, in this case SPI on PORTD has been chosen:<ul>
<li><div class="fragment"><div class="line">        <a class="code" href="group__xmega__spi__master__group.html#ga3238676989038a9dec0ebcd3aa625a42" title="Initializes the SPI in master mode.">spi_master_init</a>(&amp;SPID);</div>
</div><!-- fragment --></li>
</ul>
</li>
<li>Setup the SPI master module for a specific device:<ul>
<li><div class="fragment"><div class="line">        <a class="code" href="group__xmega__spi__master__group.html#ga81164f6dd2297a64337f3a052171e0f8" title="Setup a SPI device.">spi_master_setup_device</a>(&amp;SPID, &amp;spi_device_conf, <a class="code" href="group__xmega__spi__master__group.html#ga1ec07ad94d5f6276c1c0b41d0550fe52" title="SPI mode 0.">SPI_MODE_0</a>, 1000000, 0);</div>
</div><!-- fragment --></li>
<li><dl class="section note"><dt>Note:</dt><dd>The last argument, which is zero in this case, can be ignored and is only included for compatibility purposes.</dd></dl>
</li>
</ul>
</li>
<li>Then enable the SPI:<ul>
<li><div class="fragment"><div class="line">        <a class="code" href="group__xmega__spi__master__group.html#ga82974e81370360e53b1276113de8a462" title="Enables the SPI.">spi_enable</a>(&amp;SPID);</div>
</div><!-- fragment --></li>
</ul>
</li>
</ol>
<h1><a class="anchor" id="spi_master_xmega_basic_usage"></a>
Usage steps</h1>
<h2><a class="anchor" id="spi_master_xmega_basic_usage_code"></a>
Example code</h2>
<p>Add to, e.g., the main loop in the application C-file: </p>
<div class="fragment"><div class="line">           uint8_t data_buffer[1] = {0xAA};</div>
<div class="line"></div>
<div class="line">           <span class="keyword">struct </span><a class="code" href="structspi__device.html" title="Polled SPI device definition.">spi_device</a> spi_device_conf = {</div>
<div class="line">               .<a class="code" href="structspi__device.html#a46fd65e51a4d6c4d6056639a4f154186" title="Board specific select id.">id</a> = <a class="code" href="group__ioport__group.html#gabc09edad7c3187dec63ce47e6f1b3c51" title="Create IOPORT pin number.">IOPORT_CREATE_PIN</a>(PORTD, 1)</div>
<div class="line">           };</div>
<div class="line"></div>
<div class="line">           <a class="code" href="group__xmega__spi__master__group.html#gac8751c855b90ea2774b5007f519e487e" title="Select given device on the SPI bus.">spi_select_device</a>(&amp;SPID, &amp;spi_device_conf);</div>
<div class="line"></div>
<div class="line">           <a class="code" href="group__xmega__spi__master__group.html#ga60595beff80eae31c8dad32a8720865a" title="Send a sequence of bytes to a SPI device.">spi_write_packet</a>(&amp;SPID, data_buffer, 1);</div>
<div class="line">           <a class="code" href="group__xmega__spi__master__group.html#ga504ee6688009acff607e0304cc59278d" title="Receive a sequence of bytes from a SPI device.">spi_read_packet</a>(&amp;SPID, data_buffer, 1);</div>
<div class="line"></div>
<div class="line">           <a class="code" href="group__xmega__spi__master__group.html#gad528d94d606bda0fa6503f77a6a7bb78" title="Deselect given device on the SPI bus.">spi_deselect_device</a>(&amp;SPID, &amp;spi_device_conf);</div>
</div><!-- fragment --><h2><a class="anchor" id="spi_master_xmega_basic_usage_flow"></a>
Workflow</h2>
<ol type="1">
<li>Create a buffer for data to be sent/received on the SPI bus, in this case a single byte buffer is used. The buffer can be of arbitrary size as long as there is space left in SRAM:<ul>
<li><div class="fragment"><div class="line">        uint8_t data_buffer[1] = {0xAA};</div>
</div><!-- fragment --></li>
</ul>
</li>
<li>Define the SPI device configuration struct to describe which pin the slave select (slave chip select) is connected to, in this case the slave select pin has been connected to PORTD pin 1 (PD1):<ul>
<li><div class="fragment"><div class="line">        <span class="keyword">struct </span><a class="code" href="structspi__device.html" title="Polled SPI device definition.">spi_device</a> spi_device_conf = {</div>
<div class="line">            .<a class="code" href="structspi__device.html#a46fd65e51a4d6c4d6056639a4f154186" title="Board specific select id.">id</a> = <a class="code" href="group__ioport__group.html#gabc09edad7c3187dec63ce47e6f1b3c51" title="Create IOPORT pin number.">IOPORT_CREATE_PIN</a>(PORTD, 1)</div>
<div class="line">        };</div>
</div><!-- fragment --></li>
<li><dl class="section note"><dt>Note:</dt><dd>As this struct is the same for both the initializing part and the usage part it could be a good idea to make the struct global, and hence accessible for both the initializing part and usage part. Another solution could be to create the struct in the main function and pass the address of the struct to the spi_init_module() function, e.g.: <div class="fragment"><div class="line">           <span class="keywordtype">void</span> spi_init_module(<span class="keyword">struct</span> <a class="code" href="structspi__device.html" title="Polled SPI device definition.">spi_device</a> *spi_device_conf)</div>
<div class="line">           {</div>
<div class="line">               ...</div>
<div class="line"></div>
<div class="line">               <a class="code" href="group__xmega__spi__master__group.html#ga81164f6dd2297a64337f3a052171e0f8" title="Setup a SPI device.">spi_master_setup_device</a>(&amp;SPID, spi_device_conf, <a class="code" href="group__xmega__spi__master__group.html#ga1ec07ad94d5f6276c1c0b41d0550fe52" title="SPI mode 0.">SPI_MODE_0</a>, 1000000, 0);</div>
<div class="line"></div>
<div class="line">               ...</div>
<div class="line">           }</div>
</div><!-- fragment --></dd></dl>
</li>
</ul>
</li>
<li>Write data to the SPI slave device, in this case write one byte from the data_buffer:<ul>
<li><div class="fragment"><div class="line">        <a class="code" href="group__xmega__spi__master__group.html#ga60595beff80eae31c8dad32a8720865a" title="Send a sequence of bytes to a SPI device.">spi_write_packet</a>(&amp;SPID, data_buffer, 1);</div>
</div><!-- fragment --></li>
</ul>
</li>
<li>Read data from the SPI slave device, in this case read one byte and put it into the data_buffer:<ul>
<li><div class="fragment"><div class="line">        <a class="code" href="group__xmega__spi__master__group.html#ga504ee6688009acff607e0304cc59278d" title="Receive a sequence of bytes from a SPI device.">spi_read_packet</a>(&amp;SPID, data_buffer, 1);</div>
</div><!-- fragment --></li>
<li><dl class="section attention"><dt>Attention:</dt><dd>As the SPI works as a shift register so that data is shifted in at the same time as data is shifted out a read operation will mean that a dummy byte <a class="el" href="group__xmega__spi__master__group.html#ga64f5ff62d19aab1a97cc5e72e062be49">CONFIG_SPI_MASTER_DUMMY</a> is written to the SPI bus. <a class="el" href="group__xmega__spi__master__group.html#ga64f5ff62d19aab1a97cc5e72e062be49">CONFIG_SPI_MASTER_DUMMY</a> defaults to 0xFF, but can be changed by defining it inside the <a class="el" href="conf__spi__master_8h.html">conf_spi_master.h</a> file.</dd></dl>
</li>
</ul>
</li>
<li>When read and write operations is done de-select the slave:<ul>
<li><div class="fragment"><div class="line">        <a class="code" href="group__xmega__spi__master__group.html#gad528d94d606bda0fa6503f77a6a7bb78" title="Deselect given device on the SPI bus.">spi_deselect_device</a>(&amp;SPID, &amp;spi_device_conf);</div>
</div><!-- fragment --> </li>
</ul>
</li>
</ol>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Oct 10 2017 23:17:48 for OnePos by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.1.1
</small></address>
</body>
</html>
