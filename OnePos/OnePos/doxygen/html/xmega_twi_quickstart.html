<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>OnePos: Quick start guide for XMEGA TWI driver</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">OnePos
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Quick start guide for XMEGA TWI driver </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This is the quick start guide for the <a class="el" href="group__group__xmega__drivers__twi.html">TWI Driver</a>, with step-by-step instructions on how to configure and use the driver for specific use cases.</p>
<p>The section described below can be compiled into e.g. the main application loop or any other function that might use the TWI functionality.</p>
<h1><a class="anchor" id="xmega_twi_quickstart_basic"></a>
Basic use case of the TWI driver</h1>
<p>In our basic use case, the TWI driver is used to set up internal communication between two TWI modules on the XMEGA A1 Xplained board, since this is the most simple way to show functionality without external dependencies. TWIC is set up in master mode, and TWIF is set up in slave mode, and these are connected together on the board by placing a connection between SDA/SCL on J1 to SDA/SCL on J4.</p>
<h1><a class="anchor" id="xmega_twi_qs_use_cases"></a>
Specific use case for XMEGA E devices</h1>
<ul>
<li><a class="el" href="xmega_twi_xmegae.html">XMEGA E TWI additions with Bridge and Fast Mode Plus</a></li>
</ul>
<h1><a class="anchor" id="xmega_twi_quickstart_prereq"></a>
Prerequisites</h1>
<p>The <a class="el" href="group__sysclk__group.html">System Clock Management</a> module is required to enable the clock to the TWI modules. The <a class="el" href="group__group__xmega__drivers__twi__twim.html">TWI Master</a> driver and <a class="el" href="group__group__xmega__drivers__twi__twis.html">TWI Slave</a> driver must also be included.</p>
<h1><a class="anchor" id="xmega_twi_quickstart_setup"></a>
Setup</h1>
<p>When the <a class="el" href="group__sysclk__group.html">System Clock Management</a> module has been included, it must be initialized: </p>
<div class="fragment"><div class="line">        <a class="code" href="group__sysclk__group.html#ga242399e48a97739c88b4d0c00f6101de" title="Initialize the synchronous clock system.">sysclk_init</a>();</div>
</div><!-- fragment --><h1><a class="anchor" id="xmega_twi_quickstart_use_case"></a>
Use case</h1>
<h2><a class="anchor" id="xmega_twi_quickstart_use_case_example_code"></a>
Example code</h2>
<div class="fragment"><div class="line"><span class="preprocessor">         #define TWI_MASTER       TWIC</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">         #define TWI_MASTER_PORT  PORTC</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">         #define TWI_SLAVE        TWIF</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">         #define TWI_SPEED        50000</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">         #define TWI_MASTER_ADDR  0x50</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">         #define TWI_SLAVE_ADDR   0x60</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">         #define DATA_LENGTH     8</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">         <a class="code" href="struct_t_w_i___slave.html" title="TWI slave driver struct.">TWI_Slave_t</a> slave;</div>
<div class="line"></div>
<div class="line">         uint8_t data[DATA_LENGTH] = {</div>
<div class="line">             0x0f, 0x1f, 0x2f, 0x3f, 0x4f, 0x5f, 0x6f, 0x7f</div>
<div class="line">         };</div>
<div class="line"></div>
<div class="line">         uint8_t recv_data[DATA_LENGTH] = {</div>
<div class="line">             0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00</div>
<div class="line">         };</div>
<div class="line"></div>
<div class="line">         <a class="code" href="structtwi__options__t.html" title="Input parameters when initializing the twi module mode.">twi_options_t</a> m_options = {</div>
<div class="line">             .<a class="code" href="structtwi__options__t.html#ad81e7400d394a2f72d7ad84588d3d661" title="The baudrate of the TWI bus.">speed</a>     = TWI_SPEED,</div>
<div class="line">             .chip      = TWI_MASTER_ADDR,</div>
<div class="line">             .speed_reg = <a class="code" href="group__group__xmega__drivers__twi__twim.html#gaf373fdbc2054cf1a070ba2a24ddaedf3">TWI_BAUD</a>(sysclk_get_cpu_hz(), TWI_SPEED)</div>
<div class="line">         };</div>
<div class="line"></div>
<div class="line">         <span class="keyword">static</span> <span class="keywordtype">void</span> slave_process(<span class="keywordtype">void</span>) {</div>
<div class="line">             <span class="keywordtype">int</span> i;</div>
<div class="line"></div>
<div class="line">             <span class="keywordflow">for</span>(i = 0; i &lt; DATA_LENGTH; i++) {</div>
<div class="line">                 recv_data[i] = slave.<a class="code" href="struct_t_w_i___slave.html#a8c205728fdea8bcaeaa0f6f889d83d4d">receivedData</a>[i];</div>
<div class="line">             }</div>
<div class="line">         }</div>
<div class="line"></div>
<div class="line">         ISR(TWIF_TWIS_vect) {</div>
<div class="line">             <a class="code" href="group__group__xmega__drivers__twi__twis.html#ga0b140fb1b0b3f204e5c748c5f585fbb2" title="Common TWI slave interrupt service routine.">TWI_SlaveInterruptHandler</a>(&amp;slave);</div>
<div class="line">         }</div>
<div class="line"></div>
<div class="line">         <span class="keywordtype">void</span> send_and_recv_twi()</div>
<div class="line">         {</div>
<div class="line">             <a class="code" href="structtwi__package__t.html" title="Information concerning the data transmission.">twi_package_t</a> packet = {</div>
<div class="line">                 .<a class="code" href="structtwi__package__t.html#a397e982e6fa809c3fb834309537ffdbd" title="Length of the TWI data address segment (1-3 bytes).">addr_length</a> = 0,</div>
<div class="line">                 .chip        = TWI_SLAVE_ADDR,</div>
<div class="line">                 .buffer      = (<span class="keywordtype">void</span> *)data,</div>
<div class="line">                 .length      = DATA_LENGTH,</div>
<div class="line">                 .no_wait     = <span class="keyword">false</span></div>
<div class="line">             };</div>
<div class="line"></div>
<div class="line">             uint8_t i;</div>
<div class="line"></div>
<div class="line">             TWI_MASTER_PORT.PIN0CTRL = PORT_OPC_WIREDANDPULL_gc;</div>
<div class="line">             TWI_MASTER_PORT.PIN1CTRL = PORT_OPC_WIREDANDPULL_gc;</div>
<div class="line"></div>
<div class="line">             irq_initialize_vectors();</div>
<div class="line"></div>
<div class="line">             sysclk_enable_peripheral_clock(&amp;TWI_MASTER);</div>
<div class="line">             <a class="code" href="group__group__xmega__drivers__twi__twim.html#ga8029a07f3322bf43c289f5acb442ef29" title="Initialize the twi master module.">twi_master_init</a>(&amp;TWI_MASTER, &amp;m_options);</div>
<div class="line">             twi_master_enable(&amp;TWI_MASTER);</div>
<div class="line"></div>
<div class="line">             sysclk_enable_peripheral_clock(&amp;TWI_SLAVE);</div>
<div class="line">             <a class="code" href="group__group__xmega__drivers__twi__twis.html#ga14b9327d32373a2481e23bec041cbd7e" title="Initalizes TWI slave driver structure.">TWI_SlaveInitializeDriver</a>(&amp;slave, &amp;TWI_SLAVE, *slave_process);</div>
<div class="line">             <a class="code" href="group__group__xmega__drivers__twi__twis.html#ga7516e604cb0aacddd8d1016a54039752" title="Initialize the TWI module.">TWI_SlaveInitializeModule</a>(&amp;slave, TWI_SLAVE_ADDR,</div>
<div class="line">                     TWI_SLAVE_INTLVL_MED_gc);</div>
<div class="line"></div>
<div class="line">             <span class="keywordflow">for</span> (i = 0; i &lt; TWIS_SEND_BUFFER_SIZE; i++) {</div>
<div class="line">                 slave.<a class="code" href="struct_t_w_i___slave.html#a8c205728fdea8bcaeaa0f6f889d83d4d">receivedData</a>[i] = 0;</div>
<div class="line">             }</div>
<div class="line"></div>
<div class="line">             <a class="code" href="group__interrupt__group.html#gae4922a4bd8ba4150211fbc7f2302403c" title="Enable interrupts globally.">cpu_irq_enable</a>();</div>
<div class="line"></div>
<div class="line">             twi_master_write(&amp;TWI_MASTER, &amp;packet);</div>
<div class="line"></div>
<div class="line">             <span class="keywordflow">do</span> {</div>
<div class="line">                 <span class="comment">// Nothing</span></div>
<div class="line">             } <span class="keywordflow">while</span>(slave.<a class="code" href="struct_t_w_i___slave.html#a38f52b1274d890275ae25f68d289c8d8">result</a> != TWIS_RESULT_OK);</div>
<div class="line">         }</div>
</div><!-- fragment --><h2><a class="anchor" id="xmega_twi_quickstart_use_case_workflow"></a>
Workflow</h2>
<p>We first create some definitions. TWI master and slave, speed, and addresses: </p>
<div class="fragment"><div class="line"><span class="preprocessor">         #define TWI_MASTER       TWIC</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">         #define TWI_MASTER_PORT  PORTC</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">         #define TWI_SLAVE        TWIF</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">         #define TWI_SPEED        50000</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">         #define TWI_MASTER_ADDR  0x50</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">         #define TWI_SLAVE_ADDR   0x60</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">         #define DATA_LENGTH     8</span></div>
</div><!-- fragment --><p>We create a handle to contain information about the slave module: </p>
<div class="fragment"><div class="line">        <a class="code" href="struct_t_w_i___slave.html" title="TWI slave driver struct.">TWI_Slave_t</a> slave;</div>
</div><!-- fragment --><p>We create two variables, one which contains data that will be transmitted, and one which will contain the received data: </p>
<div class="fragment"><div class="line">         uint8_t data[DATA_LENGTH] = {</div>
<div class="line">             0x0f, 0x1f, 0x2f, 0x3f, 0x4f, 0x5f, 0x6f, 0x7f</div>
<div class="line">         };</div>
<div class="line"></div>
<div class="line">         uint8_t recv_data[DATA_LENGTH] = {</div>
<div class="line">             0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00</div>
<div class="line">         };</div>
</div><!-- fragment --><p>Options for the TWI module initialization procedure are given below: </p>
<div class="fragment"><div class="line">        <a class="code" href="structtwi__options__t.html" title="Input parameters when initializing the twi module mode.">twi_options_t</a> m_options = {</div>
<div class="line">            .<a class="code" href="structtwi__options__t.html#ad81e7400d394a2f72d7ad84588d3d661" title="The baudrate of the TWI bus.">speed</a>     = TWI_SPEED,</div>
<div class="line">            .chip      = TWI_MASTER_ADDR,</div>
<div class="line">            .speed_reg = <a class="code" href="group__group__xmega__drivers__twi__twim.html#gaf373fdbc2054cf1a070ba2a24ddaedf3">TWI_BAUD</a>(sysclk_get_cpu_hz(), TWI_SPEED)</div>
<div class="line">        };</div>
</div><!-- fragment --><p>The TWI slave will fire an interrupt when it has received data, and the function below will be called, which will copy the data from the driver to our recv_data buffer: </p>
<div class="fragment"><div class="line">         <span class="keyword">static</span> <span class="keywordtype">void</span> slave_process(<span class="keywordtype">void</span>) {</div>
<div class="line">             <span class="keywordtype">int</span> i;</div>
<div class="line"></div>
<div class="line">             <span class="keywordflow">for</span>(i = 0; i &lt; DATA_LENGTH; i++) {</div>
<div class="line">                 recv_data[i] = slave.<a class="code" href="struct_t_w_i___slave.html#a8c205728fdea8bcaeaa0f6f889d83d4d">receivedData</a>[i];</div>
<div class="line">             }</div>
<div class="line">         }</div>
</div><!-- fragment --><p>Set up the interrupt handler: </p>
<div class="fragment"><div class="line">        ISR(TWIF_TWIS_vect) {</div>
<div class="line">            <a class="code" href="group__group__xmega__drivers__twi__twis.html#ga0b140fb1b0b3f204e5c748c5f585fbb2" title="Common TWI slave interrupt service routine.">TWI_SlaveInterruptHandler</a>(&amp;slave);</div>
<div class="line">        }</div>
</div><!-- fragment --><p>We create a packet for the data that we will send to the slave TWI: </p>
<div class="fragment"><div class="line">        <a class="code" href="structtwi__package__t.html" title="Information concerning the data transmission.">twi_package_t</a> packet = {</div>
<div class="line">            .<a class="code" href="structtwi__package__t.html#a397e982e6fa809c3fb834309537ffdbd" title="Length of the TWI data address segment (1-3 bytes).">addr_length</a> = 0,</div>
<div class="line">            .chip        = TWI_SLAVE_ADDR,</div>
<div class="line">            .buffer      = (<span class="keywordtype">void</span> *)data,</div>
<div class="line">            .length      = DATA_LENGTH,</div>
<div class="line">            .no_wait     = <span class="keyword">false</span></div>
<div class="line">        };</div>
</div><!-- fragment --><p>We need to set SDA/SCL pins for the master TWI to be wired and enable pull-up: </p>
<div class="fragment"><div class="line">        TWI_MASTER_PORT.PIN0CTRL = PORT_OPC_WIREDANDPULL_gc;</div>
<div class="line">        TWI_MASTER_PORT.PIN1CTRL = PORT_OPC_WIREDANDPULL_gc;</div>
</div><!-- fragment --><p>We enable all interrupt levels: </p>
<div class="fragment"><div class="line">        irq_initialize_vectors();</div>
</div><!-- fragment --><p>We enable the clock to the master module, and initialize it with the options we described before: </p>
<div class="fragment"><div class="line">        sysclk_enable_peripheral_clock(&amp;TWI_MASTER);</div>
<div class="line">        <a class="code" href="group__group__xmega__drivers__twi__twim.html#ga8029a07f3322bf43c289f5acb442ef29" title="Initialize the twi master module.">twi_master_init</a>(&amp;TWI_MASTER, &amp;m_options);</div>
<div class="line">        twi_master_enable(&amp;TWI_MASTER);</div>
</div><!-- fragment --><p>We do the same for the slave, using the slave portion of the driver, passing through the slave_process function, its address, and set medium interrupt level: </p>
<div class="fragment"><div class="line">        sysclk_enable_peripheral_clock(&amp;TWI_SLAVE);</div>
<div class="line">        <a class="code" href="group__group__xmega__drivers__twi__twis.html#ga14b9327d32373a2481e23bec041cbd7e" title="Initalizes TWI slave driver structure.">TWI_SlaveInitializeDriver</a>(&amp;slave, &amp;TWI_SLAVE, *slave_process);</div>
<div class="line">        <a class="code" href="group__group__xmega__drivers__twi__twis.html#ga7516e604cb0aacddd8d1016a54039752" title="Initialize the TWI module.">TWI_SlaveInitializeModule</a>(&amp;slave, TWI_SLAVE_ADDR,</div>
<div class="line">                TWI_SLAVE_INTLVL_MED_gc);</div>
</div><!-- fragment --><p>We zero out the receive buffer in the slave handle: </p>
<div class="fragment"><div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; TWIS_SEND_BUFFER_SIZE; i++) {</div>
<div class="line">            slave.<a class="code" href="struct_t_w_i___slave.html#a8c205728fdea8bcaeaa0f6f889d83d4d">receivedData</a>[i] = 0;</div>
<div class="line">        }</div>
</div><!-- fragment --><p>And enable interrupts: </p>
<div class="fragment"><div class="line">        <a class="code" href="group__interrupt__group.html#gae4922a4bd8ba4150211fbc7f2302403c" title="Enable interrupts globally.">cpu_irq_enable</a>();</div>
</div><!-- fragment --><p>Finally, we write our packet through the master TWI module: </p>
<div class="fragment"><div class="line">        twi_master_write(&amp;TWI_MASTER, &amp;packet);</div>
</div><!-- fragment --><p>We wait for the slave to finish receiving: </p>
<div class="fragment"><div class="line">        <span class="keywordflow">do</span> {</div>
<div class="line">            <span class="comment">// Waiting</span></div>
<div class="line">        } <span class="keywordflow">while</span>(slave.<a class="code" href="struct_t_w_i___slave.html#a38f52b1274d890275ae25f68d289c8d8">result</a> != TWIS_RESULT_OK);</div>
</div><!-- fragment --> <dl class="section note"><dt>Note:</dt><dd>When the slave has finished receiving, the slave_process() function will copy the received data into our recv_data buffer, which now contains what was sent through the master. </dd></dl>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Oct 10 2017 23:17:48 for OnePos by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.1.1
</small></address>
</body>
</html>
