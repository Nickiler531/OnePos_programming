<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>OnePos: Quick start guide for USB device Communication Class Device module (UDI CDC)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">OnePos
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Quick start guide for USB device Communication Class Device module (UDI CDC) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This is the quick start guide for the <a class="el" href="group__udi__cdc__group.html">USB device interface CDC module (UDI CDC)</a> with step-by-step instructions on how to configure and use the modules in a selection of use cases.</p>
<p>The use cases contain several code fragments. The code fragments in the steps for setup can be copied into a custom initialization function, while the steps for usage can be copied into, e.g., the main application function.</p>
<h1><a class="anchor" id="udi_cdc_basic_use_case"></a>
Basic use case</h1>
<p>In this basic use case, the "USB CDC (Single Interface Device)" module is used with only one communication port. The "USB CDC (Composite Device)" module usage is described in <a class="el" href="udi_cdc_quickstart.html#udi_cdc_use_cases">Advanced use cases</a>.</p>
<h1><a class="anchor" id="udi_cdc_basic_use_case_setup"></a>
Setup steps</h1>
<h2><a class="anchor" id="udi_cdc_basic_use_case_setup_prereq"></a>
Prerequisites</h2>
<p>Common prerequisites for all USB devices.This module is based on USB device stack full interrupt driven, and supporting <a class="el" href="group__sleepmgr__group.html">Sleep manager</a> sleepmgr. For AVR and SAM3/4 devices the <a class="el" href="group__clk__group.html">Clock Management</a> clock services is supported. For SAMD devices the asfdoc_sam0_system_clock_group clock driver is supported.The following procedure must be executed to setup the project correctly:</p>
<ul>
<li>Specify the clock configuration:<ul>
<li>XMEGA USB devices need 48MHz clock input.<br/>
 XMEGA USB devices need CPU frequency higher than 12MHz.<br/>
 You can use either an internal RC48MHz auto calibrated by Start of Frames or an external OSC.</li>
<li>UC3 and SAM3/4 devices without USB high speed support need 48MHz clock input.<br/>
 You must use a PLL and an external OSC.</li>
<li>UC3 and SAM3/4 devices with USB high speed support need 12MHz clock input.<br/>
 You must use an external OSC.</li>
<li>UC3 devices with USBC hardware need CPU frequency higher than 25MHz.</li>
<li>SAMD devices without USB high speed support need 48MHz clock input.<br/>
 You should use DFLL with USBCRM.</li>
</ul>
</li>
<li>In <a class="el" href="conf__board_8h.html" title="User board configuration template.">conf_board.h</a>, the define CONF_BOARD_USB_PORT must be added to enable USB lines. (Not mandatory for all boards)</li>
<li>Enable interrupts</li>
<li>Initialize the clock service</li>
</ul>
The usage of <a class="el" href="group__sleepmgr__group.html">Sleep manager</a> sleepmgr service is optional, but recommended to reduce power consumption:</p>
<ul>
<li>Initialize the sleep manager service</li>
<li>Activate sleep mode when the application is in IDLE state</li>
</ul>
<a class="el" href="udc_conf_clock.html">conf_clock.h examples with USB support</a>.for AVR and SAM3/4 devices, add to the initialization code: </p>
<div class="fragment"><div class="line">        <a class="code" href="group__sysclk__group.html#ga242399e48a97739c88b4d0c00f6101de" title="Initialize the synchronous clock system.">sysclk_init</a>();</div>
<div class="line">        irq_initialize_vectors();</div>
<div class="line">        <a class="code" href="group__interrupt__group.html#gae4922a4bd8ba4150211fbc7f2302403c" title="Enable interrupts globally.">cpu_irq_enable</a>();</div>
<div class="line">        <a class="code" href="group__group__common__boards.html#ga916f2adc2080b4fe88034086d107a8dc" title="This function initializes the board target resources.">board_init</a>();</div>
<div class="line">        sleepmgr_init(); <span class="comment">// Optional</span></div>
</div><!-- fragment -->For SAMD devices, add to the initialization code: </p>
<div class="fragment"><div class="line">        system_init();</div>
<div class="line">        irq_initialize_vectors();</div>
<div class="line">        <a class="code" href="group__interrupt__group.html#gae4922a4bd8ba4150211fbc7f2302403c" title="Enable interrupts globally.">cpu_irq_enable</a>();</div>
<div class="line">        sleepmgr_init(); <span class="comment">// Optional</span></div>
</div><!-- fragment --><p> Add to the main IDLE loop: </p>
<div class="fragment"><div class="line">        sleepmgr_enter_sleep(); <span class="comment">// Optional</span></div>
</div><!-- fragment -->  </p>
<h2><a class="anchor" id="udi_cdc_basic_use_case_setup_code"></a>
Example code</h2>
<p>Common example code for all USB devices.Content of <a class="el" href="conf__usb_8h.html" title="USB configuration file for CDC application.">conf_usb.h</a>: </p>
<div class="fragment"><div class="line"><span class="preprocessor">        #define USB_DEVICE_VENDOR_ID 0x03EB</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">        #define USB_DEVICE_PRODUCT_ID 0xXXXX</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">        #define USB_DEVICE_MAJOR_VERSION 1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">        #define USB_DEVICE_MINOR_VERSION 0</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">        #define USB_DEVICE_POWER 100</span></div>
<div class="line"><span class="preprocessor">        #define USB_DEVICE_ATTR USB_CONFIG_ATTR_BUS_POWERED</span></div>
</div><!-- fragment -->Add to application C-file: </p>
<div class="fragment"><div class="line">        <span class="keywordtype">void</span> usb_init(<span class="keywordtype">void</span>)</div>
<div class="line">        {</div>
<div class="line">          <a class="code" href="group__udc__group__interne.html#gadf4e193509cd03ab6333d62629ea51e7" title="Start the USB Device stack.">udc_start</a>();</div>
<div class="line">        }</div>
</div><!-- fragment -->  </p>
<h2><a class="anchor" id="udi_cdc_basic_use_case_setup_flow"></a>
Workflow</h2>
<p>Common workflow for all USB devices.<ol type="1">
<li>Ensure that <a class="el" href="conf__usb_8h.html" title="USB configuration file for CDC application.">conf_usb.h</a> is available and contains the following configuration which is the main USB device configuration:<ul>
<li><div class="fragment"><div class="line"> <span class="comment">// Vendor ID provided by USB org (ATMEL 0x03EB)</span></div>
<div class="line"><span class="preprocessor">        #define USB_DEVICE_VENDOR_ID 0x03EB // Type Word</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="comment">// Product ID (Atmel PID referenced in usb_atmel.h)</span></div>
<div class="line"><span class="preprocessor">        #define USB_DEVICE_PRODUCT_ID 0xXXXX // Type Word</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="comment">// Major version of the device</span></div>
<div class="line"><span class="preprocessor">        #define USB_DEVICE_MAJOR_VERSION 1 // Type Byte</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="comment">// Minor version of the device</span></div>
<div class="line"><span class="preprocessor">        #define USB_DEVICE_MINOR_VERSION 0 // Type Byte</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="comment">// Maximum device power (mA)</span></div>
<div class="line"><span class="preprocessor">        #define USB_DEVICE_POWER 100 // Type 9-bits</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="comment">// USB attributes to enable features</span></div>
<div class="line"><span class="preprocessor">        #define USB_DEVICE_ATTR USB_CONFIG_ATTR_BUS_POWERED // Flags </span></div>
</div><!-- fragment --></li>
</ul>
</li>
<li>Call the USB device stack start function to enable stack and start USB:<ul>
<li><div class="fragment"><div class="line"> <a class="code" href="group__udc__group__interne.html#gadf4e193509cd03ab6333d62629ea51e7" title="Start the USB Device stack.">udc_start</a>(); </div>
</div><!-- fragment --> <dl class="section note"><dt>Note:</dt><dd>In case of USB dual roles (Device and Host) managed through USB OTG connector (USB ID pin), the call of <a class="el" href="group__udc__group__interne.html#gadf4e193509cd03ab6333d62629ea51e7" title="Start the USB Device stack.">udc_start()</a> must be removed and replaced by uhc_start(). SeRefer to "AVR4950 section 6.1 Dual roles" for further information about dual roles. </dd></dl>
</li>
</ul>
</li>
</ol>
</p>
<h1><a class="anchor" id="udi_cdc_basic_use_case_usage"></a>
Usage steps</h1>
<h2><a class="anchor" id="udi_cdc_basic_use_case_usage_code"></a>
Example code</h2>
<p>Content of <a class="el" href="conf__usb_8h.html" title="USB configuration file for CDC application.">conf_usb.h</a>: </p>
<div class="fragment"><div class="line"><span class="preprocessor">         #define UDI_CDC_ENABLE_EXT(port) my_callback_cdc_enable()</span></div>
<div class="line"><span class="preprocessor"></span>         <span class="keyword">extern</span> <span class="keywordtype">bool</span> my_callback_cdc_enable(<span class="keywordtype">void</span>);</div>
<div class="line"><span class="preprocessor">         #define UDI_CDC_DISABLE_EXT(port) my_callback_cdc_disable()</span></div>
<div class="line"><span class="preprocessor"></span>         <span class="keyword">extern</span> <span class="keywordtype">void</span> my_callback_cdc_disable(<span class="keywordtype">void</span>);</div>
<div class="line"><span class="preprocessor">         #define  UDI_CDC_LOW_RATE</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">         #define  UDI_CDC_DEFAULT_RATE             115200</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">         #define  UDI_CDC_DEFAULT_STOPBITS         CDC_STOP_BITS_1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">         #define  UDI_CDC_DEFAULT_PARITY           CDC_PAR_NONE</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">         #define  UDI_CDC_DEFAULT_DATABITS         8</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">         #include &quot;<a class="code" href="udi__cdc__conf_8h.html" title="Default CDC configuration for a USB Device with a single interface.">udi_cdc_conf.h</a>&quot;</span> <span class="comment">// At the end of conf_usb.h file</span></div>
</div><!-- fragment --><p>Add to application C-file: </p>
<div class="fragment"><div class="line">         <span class="keyword">static</span> <span class="keywordtype">bool</span> my_flag_autorize_cdc_transfert = <span class="keyword">false</span>;</div>
<div class="line">         <span class="keywordtype">bool</span> my_callback_cdc_enable(<span class="keywordtype">void</span>)</div>
<div class="line">         {</div>
<div class="line">            my_flag_autorize_cdc_transfert = <span class="keyword">true</span>;</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">         }</div>
<div class="line">         <span class="keywordtype">void</span> my_callback_cdc_disable(<span class="keywordtype">void</span>)</div>
<div class="line">         {</div>
<div class="line">            my_flag_autorize_cdc_transfert = <span class="keyword">false</span>;</div>
<div class="line">         }</div>
<div class="line"></div>
<div class="line">         <span class="keywordtype">void</span> task(<span class="keywordtype">void</span>)</div>
<div class="line">         {</div>
<div class="line">            <span class="keywordflow">if</span> (my_flag_autorize_cdc_transfert) {</div>
<div class="line">                <a class="code" href="group__udi__cdc__group.html#ga8faae3fcf4911017c0fcf0aa127179f6" title="Puts a byte on CDC line The type int is used to support printf redirection from compiler LIB...">udi_cdc_putc</a>(<span class="charliteral">&#39;A&#39;</span>);</div>
<div class="line">                <a class="code" href="group__udi__cdc__group.html#ga202f3fd7b153f6e1a41601735e0febb6" title="Waits and gets a value on CDC line.">udi_cdc_getc</a>();</div>
<div class="line">            }</div>
<div class="line">         }</div>
</div><!-- fragment --><h2><a class="anchor" id="udi_cdc_basic_use_case_setup_flow"></a>
Workflow</h2>
<ol type="1">
<li>Ensure that <a class="el" href="conf__usb_8h.html" title="USB configuration file for CDC application.">conf_usb.h</a> is available and contains the following configuration which is the USB device CDC configuration:<ul>
<li><div class="fragment"><div class="line"><span class="preprocessor"> #define USB_DEVICE_SERIAL_NAME  &quot;12...EF&quot; // Disk SN for CDC </span></div>
</div><!-- fragment --> <dl class="section note"><dt>Note:</dt><dd>The USB serial number is mandatory when a CDC interface is used.</dd></dl>
</li>
<li><div class="fragment"><div class="line"><span class="preprocessor"> #define UDI_CDC_ENABLE_EXT(port) my_callback_cdc_enable()</span></div>
<div class="line"><span class="preprocessor">         extern bool my_callback_cdc_enable(void); </span></div>
</div><!-- fragment --> <dl class="section note"><dt>Note:</dt><dd>After the device enumeration (detecting and identifying USB devices), the USB host starts the device configuration. When the USB CDC interface from the device is accepted by the host, the USB host enables this interface and the <a class="el" href="conf__usb_8h.html#a92db3a8270e5011f3154275000f8cb7d" title="Interface callback definition.">UDI_CDC_ENABLE_EXT()</a> callback function is called and return true. Thus, when this event is received, the data transfer on CDC interface are authorized.</dd></dl>
</li>
<li><div class="fragment"><div class="line"><span class="preprocessor"> #define UDI_CDC_DISABLE_EXT(port) my_callback_cdc_disable()</span></div>
<div class="line"><span class="preprocessor">         extern void my_callback_cdc_disable(void); </span></div>
</div><!-- fragment --> <dl class="section note"><dt>Note:</dt><dd>When the USB device is unplugged or is reset by the USB host, the USB interface is disabled and the UDI_CDC_DISABLE_EXT() callback function is called. Thus, the data transfer must be stopped on CDC interface.</dd></dl>
</li>
<li><div class="fragment"><div class="line"><span class="preprocessor"> #define  UDI_CDC_LOW_RATE </span></div>
</div><!-- fragment --> <dl class="section note"><dt>Note:</dt><dd>Define it when the transfer CDC Device to Host is a low rate (&lt;512000 bauds) to reduce CDC buffers size.</dd></dl>
</li>
<li><div class="fragment"><div class="line"><span class="preprocessor"> #define  UDI_CDC_DEFAULT_RATE             115200</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">        #define  UDI_CDC_DEFAULT_STOPBITS         CDC_STOP_BITS_1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">        #define  UDI_CDC_DEFAULT_PARITY           CDC_PAR_NONE</span></div>
<div class="line"><span class="preprocessor">        #define  UDI_CDC_DEFAULT_DATABITS         8 </span></div>
</div><!-- fragment --> <dl class="section note"><dt>Note:</dt><dd>Default configuration of communication port at startup.</dd></dl>
</li>
</ul>
</li>
<li>Send or wait data on CDC line:<ul>
<li><div class="fragment"><div class="line"> <span class="comment">// Waits and gets a value on CDC line</span></div>
<div class="line">        <span class="keywordtype">int</span> <a class="code" href="group__udi__cdc__group.html#ga202f3fd7b153f6e1a41601735e0febb6" title="Waits and gets a value on CDC line.">udi_cdc_getc</a>(<span class="keywordtype">void</span>);</div>
<div class="line">        <span class="comment">// Reads a RAM buffer on CDC line</span></div>
<div class="line">        iram_size_t <a class="code" href="group__udi__cdc__group.html#gaf100ac6cd39574749c54d203b5d7835b" title="Reads a RAM buffer on CDC line.">udi_cdc_read_buf</a>(<span class="keywordtype">int</span>* buf, iram_size_t size);</div>
<div class="line">        <span class="comment">// Puts a byte on CDC line</span></div>
<div class="line">        <span class="keywordtype">int</span> <a class="code" href="group__udi__cdc__group.html#ga8faae3fcf4911017c0fcf0aa127179f6" title="Puts a byte on CDC line The type int is used to support printf redirection from compiler LIB...">udi_cdc_putc</a>(<span class="keywordtype">int</span> value);</div>
<div class="line">        <span class="comment">// Writes a RAM buffer on CDC line</span></div>
<div class="line">        iram_size_t <a class="code" href="group__udi__cdc__group.html#ga705496169ff423f3e3d3b5ff882d3f9b" title="Writes a RAM buffer on CDC line.">udi_cdc_write_buf</a>(<span class="keyword">const</span> <span class="keywordtype">int</span>* buf, iram_size_t size); </div>
</div><!-- fragment --></li>
</ul>
</li>
</ol>
<h1><a class="anchor" id="udi_cdc_use_cases"></a>
Advanced use cases</h1>
<p>For more advanced use of the UDI CDC module, see the following use cases:</p>
<ul>
<li><a class="el" href="udi_cdc_use_case_composite.html">CDC in a composite device</a></li>
<li><a class="el" href="udc_use_case_1.html">Change USB speed</a></li>
<li><a class="el" href="udc_use_case_2.html">Use USB strings</a></li>
<li><a class="el" href="udc_use_case_3.html">Use USB remote wakeup feature</a></li>
<li>udc_use_case_4</li>
<li><a class="el" href="udc_use_case_5.html">Bus power application recommendations</a></li>
<li><a class="el" href="udc_use_case_6.html">USB dynamic serial number</a> </li>
</ul>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Oct 10 2017 23:17:48 for OnePos by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.1.1
</small></address>
</body>
</html>
